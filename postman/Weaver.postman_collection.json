{
  "info": {
    "name": "Weaver API",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Postman collection for Weaver pre-production API (API Key + Session model)"
  },
  "item": [
    {
      "name": "1. Create Job",
      "request": {
        "method": "POST",
        "header": [
          {"key": "X-API-Key", "value": "{{apiKey}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "url": {"raw": "{{baseUrl}}/insertJob.php", "host": ["{{baseUrl}}"], "path": ["insertJob.php"]},
        "body": {
          "mode": "raw",
          "raw": "{\n  \"payload\": {\n    \"type\": \"article\",\n    \"metadata\": { \"title\": \"Test Article\" },\n    \"content\": { \"format\": \"markdown\", \"body\": \"# Heading\\n\\nBody text with an image: ![Alt](asset:hero.png)\" },\n    \"assets\": [ { \"type\": \"image\", \"name\": \"hero.png\", \"url\": \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUA\", \"placement\": \"hero\" } ],\n    \"deployment\": { \"repository\": \"owner/repo\", \"filename\": \"test-article.html\" }\n  }\n}"
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "let json; try { json = pm.response.json(); } catch(e) { pm.test('Response is JSON', function(){ pm.expect.fail('Not JSON'); }); return; }",
              "pm.test('Status field success', function(){ pm.expect(json.status).to.eql('success'); });",
              "pm.test('job_id present', function(){ pm.expect(json.job_id).to.be.a('string'); });",
              "if(json.job_id){ pm.environment.set('jobId', json.job_id); }",
              "if(json.weaver_session){ pm.environment.set('session', json.weaver_session); }"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "2. Get Job Status",
      "request": {
        "method": "GET",
        "header": [
          {"key": "X-API-Key", "value": "{{apiKey}}"},
          {"key": "Authorization", "value": "Bearer {{session}}", "disabled": false}
        ],
        "url": {"raw": "{{baseUrl}}/getJobStatus.php?id={{jobId}}", "host": ["{{baseUrl}}"], "path": ["getJobStatus.php"], "query": [{"key": "id", "value": "{{jobId}}"}]}
      },
      "event": [
        {
          "listen": "test",
          "script": {"exec": [
            "let json; try { json = pm.response.json(); } catch(e) { return pm.test('Response is JSON', function(){ pm.expect.fail('Not JSON'); }); }",
            "pm.test('Job status includes id', function(){ pm.expect(json.job.id).to.eql(pm.environment.get('jobId')); });"
          ], "type": "text/javascript"}
        }
      ]
    },
    {
      "name": "3. Update Job (complete)",
      "request": {
        "method": "POST",
        "header": [
          {"key": "X-API-Key", "value": "{{apiKey}}"},
          {"key": "Content-Type", "value": "application/json"},
          {"key": "Authorization", "value": "Bearer {{session}}"}
        ],
        "url": {"raw": "{{baseUrl}}/updateJob.php", "host": ["{{baseUrl}}"], "path": ["updateJob.php"]},
        "body": {"mode": "raw", "raw": "{\n  \"job_id\": \"{{jobId}}\",\n  \"status\": \"completed\",\n  \"payload_patch\": { \"metadata\": { \"title\": \"Test Article (Updated)\" } }\n}"}
      },
      "event": [
        {"listen": "test", "script": {"exec": [
          "let json; try { json = pm.response.json(); } catch(e) { return; }",
          "pm.test('Update success', function(){ pm.expect(json.status).to.eql('success'); });"
        ], "type": "text/javascript"}}
      ]
    },
    {
      "name": "4. List Jobs",
      "request": {
        "method": "POST",
        "header": [
          {"key": "X-API-Key", "value": "{{apiKey}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "url": {"raw": "{{baseUrl}}/getAllJobs.php", "host": ["{{baseUrl}}"], "path": ["getAllJobs.php"]},
        "body": {"mode": "raw", "raw": "{\n  \"limit\": 10,\n  \"offset\": 0\n}"}
      },
      "event": [
        {"listen": "test", "script": {"exec": [
          "let json; try { json = pm.response.json(); } catch(e) { return; }",
          "pm.test('Items array', function(){ pm.expect(json.items).to.be.an('array'); });",
          "pm.test('Pagination object', function(){ pm.expect(json.pagination).to.be.an('object'); });"
        ], "type": "text/javascript"}}
      ]
    },
    {
      "name": "5. Get Job Artifact",
      "request": {
        "method": "GET",
        "header": [
          {"key": "X-API-Key", "value": "{{apiKey}}"},
          {"key": "Authorization", "value": "Bearer {{session}}"}
        ],
        "url": {"raw": "{{baseUrl}}/jobArtifact.php?id={{jobId}}", "host": ["{{baseUrl}}"], "path": ["jobArtifact.php"], "query": [{"key": "id", "value": "{{jobId}}"}]}
      },
      "event": [
        {"listen": "test", "script": {"exec": [
          "pm.test('Status code 200', function(){ pm.response.to.have.status(200); });",
          "pm.test('JSON has payload', function(){ let j=pm.response.json(); pm.expect(j.payload).to.be.an('object'); });"
        ], "type": "text/javascript"}}
      ]
    }
  ]
}
